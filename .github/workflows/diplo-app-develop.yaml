name: "Build and push image, deploy to kuber"

on:
  push:
     tags:
      - v1.*
#    branches:
#    - develop
#  pull_request:
#    branches: [ "main" ]

env:
  BRANCH: develop
  IMAGE_ID: ghcr.io/${{ github.repository_owner }}/diplo-app

jobs:
  build:
    #name: "Build image"
    runs-on: self-hosted
    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.20

    - name: Build the Docker image
      run: |-
        docker build . --file Dockerfile --tag  $IMAGE_ID-${GITHUB_REF_NAME}:${GITHUB_SHA} --tag  $IMAGE_ID-${GITHUB_REF_NAME}:latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.REGISTRY_TOKEN }}

    - name: Push image
      run: |-
        export IMAGE_ID=ghcr.io/${{ github.repository_owner }}/diplo-app-${GITHUB_REF_NAME}:${GITHUB_SHA}
        echo $IMAGE_ID
        docker push $IMAGE_ID


    - name: Copy private key from environment variable to file
      run: |-
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIV_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Deploy
      run: |
        ssh -i ~/.ssh/id_rsa debian@${{ vars.KUBE_MASTER_IP }} \
        "kubectl set image deploy/diplo-app --namespace=develop diplo-app=$IMAGE_ID-${GITHUB_REF_NAME}:${GITHUB_SHA} && \
        kubectl rollout restart deploy diplo-app --namespace=develop"





